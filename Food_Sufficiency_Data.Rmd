---
title: "Food Sufficiency Plots"
author: "Chloe Shawah"
date: "6/10/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(stringr)
library(camiller)
library(lubridate)

# There's probably a MUCH nicer way to retrieve the data, sorry! 
url <- "https://www2.census.gov/programs-surveys/demo/datasets/hhp/2020/wk4/HPS_Week04_PUF_CSV.zip"
tempdl <- tempfile()
download.file(url,tempdl, mode="wb") 
unzip(tempdl, "pulse2020_puf_04.csv") 
week4 <- read.csv("pulse2020_puf_04.csv") %>% 
filter(EST_ST == 9)
unlink(tempdl)

#DSS Data
dss <- read.csv("https://data.ct.gov/api/views/pmna-639e/rows.csv?accessType=DOWNLOAD") %>% 
  select(Date, SNAP.applications) 
  dss$Date <- as.Date(as.character(dss$Date), format='%m/%d/%Y')

```

```{r Prior to Current Food Sufficiency}

prior_suff <- week4 %>%
  filter(PRIFOODSUF != -99 & PRIFOODSUF != -88) %>%
  dplyr::count(PRIFOODSUF) %>%
  mutate(denom = sum(wt = n)) %>%
  mutate(perc = n/denom) %>% 
  mutate(time = "P") %>% 
  setNames(., c("suff", "n", "denom", "perc", "time"))

curr_suff <- week4 %>%
  filter(CURFOODSUF != -99 & CURFOODSUF != -88) %>%
  dplyr::count(CURFOODSUF) %>%
  mutate(denom = sum(wt = n)) %>%
  mutate(perc = n/denom) %>% 
  mutate(time = "C") %>% 
  setNames(., c("suff", "n", "denom", "perc", "time"))

pri_to_curr <- rbind(prior_suff, curr_suff) %>% 
  filter(suff != 1) %>% 
  mutate(suff = as.factor(suff)) %>% 
  mutate(time = as.factor(time)) %>% 
  mutate(time = fct_relevel(time, "P", "C")) %>% 
  mutate(time = fct_recode(time, "Current Food Sufficiency" = "C", "Prior to March 13, 2020" = "P")) %>% 
  mutate(suff = fct_recode(suff,
                           "Enough, but not always kinds wanted" = "2", 
                           "Sometimes not enough to eat" = "3", 
                           "Often not enough to eat" = "4"))

```

```{r Reason for Insuff}

num_curr_insuff <- curr_suff %>%
  ungroup() %>%
  filter(suff %in% c(2, 3, 4)) %>%
  tally(wt = n) %>%
  pull(n)

reason_for_insuff <- data.frame("reason" = c("Couldn't afford to buy more food", 
                                    "Couldn’t get out to buy food", 
                                    "Afraid to go or didn’t want to go out", 
                                    "Couldn’t get groceries or meals delivered", 
                                    "Stores didn’t have the food wanted"),
                       "number" = c(week4 %>% filter(FOODSUFRSN1 == 1) %>% nrow(),
                                    week4 %>% filter(FOODSUFRSN2 == 1) %>% nrow(),
                                    week4 %>% filter(FOODSUFRSN3 == 1) %>% nrow(),
                                    week4 %>% filter(FOODSUFRSN4 == 1) %>% nrow(),
                                    week4 %>% filter(FOODSUFRSN5 == 1) %>% nrow())) %>% 
  mutate(percent = number/num_curr_insuff)


```

```{r Food Resources}

num_free_food <- week4 %>%
  filter(FREEFOOD == 1) %>%
  tally(FREEFOOD) %>%
  pull(n)

resource <- data.frame("resource" = c("Free meals through the school or other programs aimed at children", 
                                    "Food pantry or food bank", 
                                    "Home-delivered meal service like Meals on Wheels", 
                                    "Church, synagogue, temple, mosque or other religious organization", 
                                    "Shelter or soup kitchen",
                                    "Other community program",
                                    "Family, friends, or neighbors"),
                       "number" = c(week4 %>% filter(WHEREFREE1 == 1) %>% nrow(),
                                      week4 %>% filter(WHEREFREE2 == 1) %>% nrow(),
                                      week4 %>% filter(WHEREFREE3 == 1) %>% nrow(),
                                      week4 %>% filter(WHEREFREE4 == 1) %>% nrow(),
                                      week4 %>% filter(WHEREFREE5 == 1) %>% nrow(),
                                      week4 %>% filter(WHEREFREE6 == 1) %>% nrow(),
                                      week4 %>% filter(WHEREFREE7 == 1) %>% nrow())) %>% 
  mutate(percent = number/num_free_food)

```

```{r Insuff by Race}

curr_suff_race <- week4 %>%
  filter(CURFOODSUF != -99 & CURFOODSUF != -88) %>%
  group_by(RRACE) %>%
  count(CURFOODSUF) %>%
  mutate(denom = sum(wt = n)) %>%
  mutate(perc = n/denom)

curr_suff_white <- curr_suff_race %>% 
  ungroup() %>% 
  filter(CURFOODSUF != 1 & RRACE == 1) %>% 
  mutate(RRACE = as.factor(RRACE)) %>% 
  mutate(RRACE = fct_recode(RRACE,"White" = "1")) %>% 
  setNames(., c("Race", "suff", "n", "denom", "Percent"))

curr_suff_black <- curr_suff_race %>% 
  ungroup() %>% 
  filter(CURFOODSUF != 1 & RRACE == 2) %>%
  mutate(RRACE = as.factor(RRACE)) %>% 
  mutate(RRACE = fct_recode(RRACE,"Black" = "2")) %>% 
  setNames(., c("Race", "suff", "n", "denom", "Percent"))
  

curr_suff_hispanic <- week4 %>%
  filter(CURFOODSUF != -99 & CURFOODSUF != -88) %>%
  group_by(RHISPANIC) %>% 
  count(CURFOODSUF) %>%
  mutate(denom = sum(wt = n)) %>%
  mutate(perc = n/denom) %>%
  ungroup() %>% 
  filter(CURFOODSUF != 1 & RHISPANIC == 2) %>% 
  mutate(RHISPANIC = as.factor(RHISPANIC)) %>% 
  mutate(RHISPANIC = fct_recode(RHISPANIC, "Latino" = "2")) %>% 
  setNames(., c("Race", "suff", "n", "denom", "Percent"))

suff_race <- rbind(curr_suff_white, curr_suff_black, curr_suff_hispanic) %>% 
  mutate(suff = as.factor(suff)) %>% 
  mutate(suff = fct_recode(suff, 
                           "Enough, but not always kinds wanted" = "2", 
                           "Sometimes not enough to eat" = "3", 
                           "Often not enough to eat" = "4"))

```


```{r Reject code to maybe resurrect later}


## Food insufficiency by work loss

# curr_suff_wrkls <- week4 %>%
#   filter(CURFOODSUF != -99 & CURFOODSUF != -88) %>%
#   filter(WRKLOSS != -99) %>%
#   group_by(WRKLOSS) %>%
#   count(CURFOODSUF) %>%
#   mutate(denom = sum(wt = n)) %>%
#   mutate(perc = n/denom)

```


```{r Visualizations}

race_plot <- ggplot(suff_race) +
  geom_bar(aes(x = suff, y = Percent, fill = Race), stat = "identity", position=position_dodge()) +
  scale_fill_brewer(palette="Dark2") +
  scale_x_discrete(labels = function(suff) str_wrap(suff, width = 10)) +
  xlab("Food sufficiency level") +
  ylab("Percent of respondents") +
  labs(title = "Food Sufficiency by Race", subtitle = "Week 4 of Pulse Survey Data") +
  camiller::theme_din() +
  theme(legend.title = element_blank())

pri_to_curr_plot <- ggplot(pri_to_curr) +
  geom_bar(aes(x = suff, y = perc, fill = time), stat = "identity", position=position_dodge()) +
  scale_fill_brewer(palette="Dark2") +
  scale_x_discrete(labels = function(suff) str_wrap(suff, width = 10)) +
  xlab("Food sufficiency level") +
  ylab("Percent of respondents") +
  labs(title = "Food Sufficiency", subtitle = "Week 4 of Pulse Survey Data") +
  camiller::theme_din() +
  theme(legend.title = element_blank())

# reason_plot <- ggplot(reason_for_insuff) +
#   geom_bar(aes(x = reorder(reason, -percent), y = percent, fill = reason), stat = "identity", show.legend = FALSE) +
#   scale_fill_brewer(palette="Dark2") +
#   scale_x_discrete(labels = function(reason) str_wrap(reason, width = 10)) +
#   xlab("Reason for Food Insufficiency") +
#   ylab("Percent of individuals with food insufficiency") +
#   labs(title = "Reason for Food Insufficiency during COVID-19", subtitle = "Week 4 of Pulse Survey Data")

resource_plot <- ggplot(resource) +
  geom_bar(aes(x = reorder(resource, -percent), y = percent, fill = resource), stat = "identity", show.legend = FALSE) +
  scale_fill_brewer(palette="Dark2") +
  scale_x_discrete(labels = function(resource) str_wrap(resource, width = 10)) +
  xlab("Source of free meals") +
  ylab("Percent of individuals who received free meals") +
  labs(title = "Resources for Food Insufficiency during COVID-19", subtitle = "Week 4 of Pulse Survey Data") +
  camiller::theme_din()

snap_plot <- ggplot(dss, aes(x=Date, y=SNAP.applications)) + 
  geom_point() +
  geom_smooth(se = FALSE, color = "red") +
  geom_vline(xintercept = as.numeric(ymd("2020-03-13")), linetype="dashed", 
                color = "gray", size=1.5) +
  camiller::theme_din() +
  labs(title = "Number of CT SNAP Applications during COVID-19") +
  xlab("Date") +
  ylab("Number of Applicants") +
  scale_x_date() +
  theme(axis.text.x=element_text(angle=90,hjust=1))

# ggsave("pri_to_curr.png", plot = pri_to_curr_plot)
# ggsave("resource.png", plot = resource_plot)
# ggsave("race.png", plot = race_plot)
# ggsave("dss_snap.png", plot = snap_plot)


```
